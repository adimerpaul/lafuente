import{_ as U,O as p,P as q,Q as a,R as n,aH as f,T as e,S as h,aF as v,X as m,Y as V,Z as _,V as b,U as s,aG as y,J as C,bd as N,aI as P,W as I,$ as Q}from"./index.8cfd3fd6.js";import{Q as D}from"./QSpace.d40ac329.js";import{Q as L}from"./QPagination.7d0653b5.js";import{Q as T}from"./QImg.b67329ad.js";import{Q as k}from"./QMarkupTable.eee695c5.js";import{Q as E}from"./QForm.ab3d8dc2.js";import{Q as w}from"./QSelect.2db691c3.js";import{Q as R}from"./QPage.9d9eacf3.js";import{I as B}from"./Imprimir.3322c09e.js";import{h as F}from"./moment.40bc58bf.js";import"./format.2cae61da.js";import"./QChip.01d1f48e.js";import"./QMenu.99a3e082.js";import"./QItemLabel.9a064e5c.js";const A={name:"VentasNew",data(){return{doctores:[],codigoTipoDocumentoIdentidades:[{value:1,label:"CI - CEDULA DE IDENTIDAD"},{value:2,label:"CEX - CED ULA DE IDENTIDAD DE EXTRANJERO"},{value:5,label:"NIT - N\xDAMERO DE IDENTIFICACI\xD3N TRIBUTARIA"},{value:3,label:"PAS - PASAPORTE"},{value:4,label:"OD - OTRO DOCUMENTO DE IDENTIDAD"}],loading:!1,ventaDialog:!1,efectivo:"",venta:{nit:"0",nombre:"SN",codigoTipoDocumentoIdentidad:1,tipo_venta:"Internado",tipo_pago:"Efectivo",doctor_id:null},pagination:{page:1,rowsPerPage:24,rowsNumber:0},receta_id:null,recognition:null,activeField:null,productos:[],productosSearch:"",productosVentas:[],loteDialog:!1,lotesLoading:!1,lotes:[],loteSelected:null,loteCantidad:1,lotePrecio:0,loteProducto:null}},mounted(){if(this.$nextTick(()=>{var i;(i=this.$refs.inputBuscarProducto)==null||i.focus()}),this.productosGet(),this.doctoresGet(),"webkitSpeechRecognition"in window||"SpeechRecognition"in window){const i=window.SpeechRecognition||window.webkitSpeechRecognition;this.recognition=new i,this.recognition.lang="es-ES",this.recognition.interimResults=!1,this.recognition.continuous=!1,this.recognition.onresult=t=>{const d=t.results[0][0].transcript;this.activeField&&(this.venta[this.activeField]+=d)},this.recognition.onerror=t=>{console.error("Error en reconocimiento de voz:",t.error)}}},methods:{doctoresGet(){this.$axios.get("doctores").then(i=>{this.doctores=i.data}).catch(()=>this.$q.notify({type:"negative",message:"No se pudieron cargar los doctores"}))},async openLoteDialog(i){var t,d;this.loteProducto=i,this.loteDialog=!0,this.lotes=[],this.lotesLoading=!0;try{const r=await this.$axios.get(`productos/${i.id}/historial-compras-ventas`);this.lotes=r.data||[],this.lotes.length===1&&this.onPickLote(this.lotes[0])}catch(r){console.error(r),(d=(t=this.$alert)==null?void 0:t.error)!=null&&d.call(t,"No se pudieron cargar los lotes")||this.$q.notify({type:"negative",message:"No se pudieron cargar los lotes"}),this.loteDialog=!1}finally{this.lotesLoading=!1}},onPickLote(i){var t,d,r;this.loteSelected=i,this.lotePrecio=Number((r=(d=i==null?void 0:i.precio_venta)!=null?d:(t=this.loteProducto)==null?void 0:t.precio)!=null?r:0),this.loteCantidad=1},confirmarLote(){var d,r,l,u;if(!this.loteSelected){(r=(d=this.$alert)==null?void 0:d.error)!=null&&r.call(d,"Selecciona un lote")||this.$q.notify({type:"negative",message:"Selecciona un lote"});return}const i=Number(this.loteSelected.disponible||0),t=Number(this.loteCantidad||0);if(t<=0||t>i){(u=(l=this.$alert)==null?void 0:l.error)!=null&&u.call(l,"Cantidad inv\xE1lida para el lote")||this.$q.notify({type:"negative",message:"Cantidad inv\xE1lida para el lote"});return}Number(this.lotePrecio||0),this.productosVentas.push({producto_id:this.loteProducto.id,cantidad:t,precio:this.loteProducto.precio,producto:this.loteProducto,compra_detalle_id:this.loteSelected.id,lote:this.loteSelected.lote,fecha_vencimiento:this.loteSelected.fecha_vencimiento}),this.loteDialog=!1,this.loteSelected=null,this.loteProducto=null,this.loteCantidad=1,this.lotePrecio=0},searchCliente(){this.loading=!0,this.$axios.post("searchCliente",{nit:this.venta.nit}).then(i=>{this.venta.nombre="SN",this.venta.email="",this.venta.codigoTipoDocumentoIdentidad=1,i.data.nombre&&(this.venta.nombre=i.data.nombre),i.data.email&&(this.venta.email=i.data.email),i.data.codigoTipoDocumentoIdentidad&&(this.venta.codigoTipoDocumentoIdentidad=parseInt(i.data.codigoTipoDocumentoIdentidad)),i.data.complemento&&(this.venta.complemento=i.data.complemento)}).catch(i=>console.error(i)).finally(()=>this.loading=!1)},clickDialogVenta(){var i,t;if(this.productosVentas.length===0){(t=(i=this.$alert)==null?void 0:i.error)!=null&&t.call(i,"Debe agregar al menos un producto a la venta")||this.$q.notify({type:"negative",message:"Debe agregar al menos un producto a la venta"});return}this.ventaDialog=!0,this.efectivo="",this.venta.tipo_venta="Externo",this.venta.fecha=F().format("YYYY-MM-DD")},productosGet(){this.loading=!0,this.$axios.get("productosCantidad",{params:{search:this.productosSearch,page:this.pagination.page,per_page:this.pagination.rowsPerPage}}).then(i=>{this.productos=i.data.data,this.pagination.rowsNumber=i.data.total,this.pagination.page=i.data.current_page,this.productos.length===1&&this.productos[0].barra===this.productosSearch&&(this.openLoteDialog(this.productos[0]),this.productosSearch="")}).catch(i=>{console.error(i)}).finally(()=>{this.loading=!1})},submitVenta(){this.loading=!0,this.$axios.post("ventas",{ci:this.venta.nit,nombre:this.venta.nombre,email:this.venta.email,codigoTipoDocumentoIdentidad:this.venta.codigoTipoDocumentoIdentidad,complemento:this.venta.complemento,productos:this.productosVentas,tipo_venta:this.venta.tipo_venta,tipo_pago:this.venta.tipo_pago,receta_id:this.receta_id,doctor_id:this.venta.doctor_id,fecha:this.venta.fecha}).then(i=>{var t,d;this.ventaDialog=!1,(d=(t=this.$alert)==null?void 0:t.success)==null||d.call(t,"Venta realizada con \xE9xito"),this.productosVentas=[],this.venta={nit:"0",nombre:"SN",codigoTipoDocumentoIdentidad:1,tipo_venta:"Internado",tipo_pago:"Efectivo"},B.reciboVentaSimple(i.data),this.receta_id=null,this.$nextTick(()=>{var r;return(r=this.$refs.inputBuscarProducto)==null?void 0:r.focus()}),this.productosGet()}).catch(i=>{var t,d,r,l;console.error(i),(l=(t=this.$alert)==null?void 0:t.error)==null||l.call(t,((r=(d=i==null?void 0:i.response)==null?void 0:d.data)==null?void 0:r.message)||"No se pudo realizar la venta")}).finally(()=>{this.loading=!1})},startRecognition(i){this.recognition?(this.activeField=i,this.recognition.start()):this.$q.notify({color:"negative",message:"El reconocimiento de voz no est\xE1 soportado en este navegador"})}},computed:{totalVenta(){return this.productosVentas.reduce((i,t)=>i+Number(t.cantidad)*Number(t.precio),0)},cambio(){let i=Number(this.efectivo||0)-this.totalVenta;return i<0&&(i=0),i.toFixed(2)}}},z={class:"row"},G={class:"col-12 col-md-7 q-pa-xs"},O={class:"flex flex-center"},M={class:"row"},Y={class:"absolute-bottom text-center",style:{padding:"0",margin:"0"}},X={style:{"max-width":"190px","line-height":"0.9"}},J={style:{display:"flex","justify-content":"space-between"}},j={class:"text-bold bg-orange text-black border"},H={class:"col-12 col-md-5 q-pa-xs"},W={class:"text-right flex items-center"},Z={style:{padding:"0",margin:"0",display:"flex","align-items":"center"}},K={style:{"max-width":"190px",overflow:"hidden","text-overflow":"ellipsis","line-height":".9"}},$={style:{padding:"0",margin:"0"}},ee=["onUpdate:modelValue"],te={style:{padding:"0",margin:"0"}},oe=["onUpdate:modelValue"],le={class:"text-right"},ie={class:"text-right text-bold"},ne={class:"row"},se={class:"col-12 col-md-3 q-pa-xs"},ae={class:"col-12 col-md-3 q-pa-xs"},de={class:"col-12 col-md-3 q-pa-xs"},re={class:"col-12 col-md-3 q-pa-xs"},ue={class:"col-12 col-md-6 q-pa-xs"},ce={class:"col-12 col-md-3 q-pa-xs"},pe={class:"col-12 col-md-3 q-pa-xs"},me={class:"col-12 col-md-6 q-pa-xs"},he={class:"col-12 col-md-6 q-pa-xs"},ge={class:"col-12 q-pa-xs"},ve={style:{padding:"0",margin:"0"}},fe={style:{"max-width":"190px",overflow:"hidden","text-overflow":"ellipsis","line-height":".9"}},be={class:"text-right"},xe={class:"text-right text-bold"},Ve={class:"text-right"},_e={class:"text-right"},ye={class:"col-12 q-pa-xs"},De={class:"q-mb-sm text-subtitle2"},we={key:0},Se={class:"text-right"},Ce={key:1},Ne={key:0,class:"row q-col-gutter-sm q-mt-sm"},Ie={class:"col-12 col-md-4"},ke={class:"col-12 col-md-4"},Pe={class:"col-12 col-md-4 flex items-end"};function Te(i,t,d,r,l,u){return p(),q(R,{class:"q-pa-xs"},{default:a(()=>[n(y,{flat:"",bordered:""},{default:a(()=>[n(f,{class:"row items-center q-pb-none"},{default:a(()=>[t[19]||(t[19]=e("div",{class:"text-h6"},"Ventas",-1)),n(h,{flat:"",round:"",dense:"",icon:"arrow_back",onClick:t[0]||(t[0]=o=>i.$router.go(-1))}),n(h,{flat:"",round:"",dense:"",icon:"refresh",onClick:u.productosGet,loading:l.loading},null,8,["onClick","loading"]),n(D)]),_:1}),n(f,{class:"q-pa-none"},{default:a(()=>[n(E,{onSubmit:u.clickDialogVenta},{default:a(()=>[e("div",z,[e("div",G,[n(v,{ref:"inputBuscarProducto",modelValue:l.productosSearch,"onUpdate:modelValue":[t[1]||(t[1]=o=>l.productosSearch=o),u.productosGet],outlined:"",clearable:"",label:"Buscar producto",dense:"",debounce:"300"},{append:a(()=>[n(h,{flat:"",round:"",dense:"",icon:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"]),e("div",O,[n(L,{size:"xs",modelValue:l.pagination.page,"onUpdate:modelValue":[t[2]||(t[2]=o=>l.pagination.page=o),u.productosGet],max:Math.ceil(l.pagination.rowsNumber/l.pagination.rowsPerPage),color:"primary","boundary-numbers":"","max-pages":"5"},null,8,["modelValue","max","onUpdate:modelValue"])]),e("div",M,[(p(!0),m(_,null,V(l.productos,o=>(p(),m("div",{key:o.id,class:"col-6 col-md-2"},[n(y,{flat:"",bordered:"",class:"cursor-pointer",onClick:c=>u.openLoteDialog(o)},{default:a(()=>[n(T,{src:`${i.$url}../images/${o.imagen}`,class:"q-mb-xs",style:{height:"120px"}},{default:a(()=>[e("div",Y,[e("div",X,s(i.$filters.textUpper(o.nombre)),1),e("div",J,[e("span",null,s(o.cantidad),1),e("span",j,s(o.precio)+" Bs",1)])])]),_:2},1032,["src"])]),_:2},1032,["onClick"])]))),128))])]),e("div",H,[e("div",W,[b(" Cantidad de productos: "+s(l.productosVentas.length)+" ",1),n(D),n(h,{icon:"delete",size:"10px",color:"red",dense:"",flat:"","no-caps":"",label:"Limpiar",onClick:t[3]||(t[3]=o=>{l.productosVentas=[],l.receta_id=null})})]),n(k,{dense:"","wrap-cells":"",flat:"",bordered:""},{default:a(()=>[t[21]||(t[21]=e("thead",null,[e("tr",null,[e("th",null,"Producto"),e("th",null,"Lote"),e("th",null,"Vence"),e("th",null,"Cantidad"),e("th",null,"Precio"),e("th",null,"Subtotal")])],-1)),e("tbody",null,[(p(!0),m(_,null,V(l.productosVentas,(o,c)=>{var g,S;return p(),m("tr",{key:c},[e("td",Z,[n(T,{src:`${i.$url}../images/${(g=o.producto)==null?void 0:g.imagen}`,class:"q-mb-xs",style:{height:"35px",width:"35px"}},null,8,["src"]),e("div",K,[n(Q,{name:"delete",color:"red",class:"cursor-pointer",onClick:x=>l.productosVentas.splice(c,1)},null,8,["onClick"]),b(" "+s(i.$filters.textUpper((S=o.producto)==null?void 0:S.nombre)),1)])]),e("td",null,s(o.lote||"\u2014"),1),e("td",null,s(o.fecha_vencimiento||"\u2014"),1),e("td",$,[C(e("input",{"onUpdate:modelValue":x=>o.cantidad=x,type:"number",style:{width:"60px"},min:"1"},null,8,ee),[[N,o.cantidad,void 0,{number:!0}]])]),e("td",te,[C(e("input",{"onUpdate:modelValue":x=>o.precio=x,type:"number",style:{width:"70px"},step:"0.01"},null,8,oe),[[N,o.precio,void 0,{number:!0}]])]),e("td",le,s((Number(o.cantidad)*Number(o.precio)).toFixed(2))+" Bs ",1)])}),128))]),e("tfoot",null,[e("tr",null,[t[20]||(t[20]=e("td",{colspan:"5",class:"text-right text-bold"},"Total",-1)),e("td",ie,s(u.totalVenta.toFixed(2))+" Bs ",1)])])]),_:1}),n(h,{label:"Realizar venta",color:"positive",class:"full-width","no-caps":"",loading:l.loading,type:"submit",icon:"add_circle_outline"},null,8,["loading"])])])]),_:1},8,["onSubmit"])]),_:1})]),_:1}),n(P,{modelValue:l.ventaDialog,"onUpdate:modelValue":t[15]||(t[15]=o=>l.ventaDialog=o)},{default:a(()=>[n(y,{style:{"max-width":"750px",width:"90vw"}},{default:a(()=>[n(f,{class:"q-pb-none row items-center"},{default:a(()=>[t[22]||(t[22]=e("div",{class:"text-h6"},"Nueva venta",-1)),n(D),n(h,{flat:"",round:"",dense:"",icon:"close",onClick:t[4]||(t[4]=o=>l.ventaDialog=!1)})]),_:1}),n(f,null,{default:a(()=>[n(E,{onSubmit:u.submitVenta},{default:a(()=>[e("div",ne,[e("div",se,[n(v,{modelValue:l.venta.nit,"onUpdate:modelValue":[t[5]||(t[5]=o=>l.venta.nit=o),u.searchCliente],outlined:"",dense:"",label:"CI/NIT",debounce:500},null,8,["modelValue","onUpdate:modelValue"])]),e("div",ae,[n(v,{modelValue:l.venta.nombre,"onUpdate:modelValue":t[6]||(t[6]=o=>l.venta.nombre=o),outlined:"",dense:"",label:"Nombre"},null,8,["modelValue"])]),e("div",de,[n(v,{modelValue:l.venta.email,"onUpdate:modelValue":t[7]||(t[7]=o=>l.venta.email=o),outlined:"",dense:"",label:"Email"},null,8,["modelValue"])]),e("div",re,[n(w,{modelValue:l.venta.tipo_venta,"onUpdate:modelValue":t[8]||(t[8]=o=>l.venta.tipo_venta=o),outlined:"",dense:"",label:"Tipo de venta",options:["Internado","Externo"]},null,8,["modelValue"])]),e("div",ue,[n(w,{modelValue:l.venta.doctor_id,"onUpdate:modelValue":t[9]||(t[9]=o=>l.venta.doctor_id=o),options:l.doctores.map(o=>({label:`${o.nombre} \u2014 ${o.especialidad||"SN"}`,value:o.id})),outlined:"",dense:"",label:"Doctor",clearable:"","emit-value":"","map-options":""},null,8,["modelValue","options"])]),e("div",ce,[n(v,{modelValue:l.venta.complemento,"onUpdate:modelValue":t[10]||(t[10]=o=>l.venta.complemento=o),outlined:"",dense:"",label:"Complemento"},null,8,["modelValue"])]),e("div",pe,[n(w,{modelValue:l.venta.tipo_pago,"onUpdate:modelValue":t[11]||(t[11]=o=>l.venta.tipo_pago=o),outlined:"",dense:"",label:"Tipo de pago",options:["Efectivo","QR"]},null,8,["modelValue"])]),e("div",me,[n(w,{modelValue:l.venta.codigoTipoDocumentoIdentidad,"onUpdate:modelValue":t[12]||(t[12]=o=>l.venta.codigoTipoDocumentoIdentidad=o),outlined:"",dense:"",label:"Tipo de documento",options:l.codigoTipoDocumentoIdentidades,"emit-value":"","map-options":""},null,8,["modelValue","options"])]),e("div",he,[n(v,{modelValue:l.venta.fecha,"onUpdate:modelValue":t[13]||(t[13]=o=>l.venta.fecha=o),outlined:"",dense:"",label:"Fecha de venta",type:"date"},null,8,["modelValue"])]),e("div",ge,[n(k,{dense:"","wrap-cells":"",flat:"",bordered:""},{default:a(()=>[t[26]||(t[26]=e("thead",null,[e("tr",null,[e("th",null,"ID"),e("th",null,"Producto"),e("th",null,"Lote"),e("th",null,"Vence"),e("th",null,"Cant."),e("th",null,"Precio"),e("th",null,"Subtotal")])],-1)),e("tbody",null,[(p(!0),m(_,null,V(l.productosVentas,(o,c)=>{var g;return p(),m("tr",{key:"prev-"+c},[e("td",null,s(o.producto_id),1),e("td",ve,[e("div",fe,s(i.$filters.textUpper(((g=o.producto)==null?void 0:g.nombre)||"")),1)]),e("td",null,s(o.lote||"\u2014"),1),e("td",null,s(o.fecha_vencimiento||"\u2014"),1),e("td",null,s(o.cantidad),1),e("td",null,s(Number(o.precio).toFixed(2))+" Bs",1),e("td",be,s((Number(o.cantidad)*Number(o.precio)).toFixed(2))+" Bs ",1)])}),128))]),e("tfoot",null,[e("tr",null,[t[23]||(t[23]=e("td",{colspan:"6",class:"text-right text-bold"},"Total",-1)),e("td",xe,s(u.totalVenta.toFixed(2))+" Bs",1)]),e("tr",null,[t[24]||(t[24]=e("td",{colspan:"6",class:"text-right text-bold"},"Efectivo",-1)),e("td",Ve,[C(e("input",{"onUpdate:modelValue":t[14]||(t[14]=o=>l.efectivo=o),type:"number",step:"0.01",style:{width:"100px"}},null,512),[[N,l.efectivo,void 0,{number:!0}]])])]),e("tr",null,[t[25]||(t[25]=e("td",{colspan:"6",class:"text-right text-bold"},"Cambio",-1)),e("td",_e,s(u.cambio),1)])])]),_:1})]),e("div",ye,[n(h,{label:"Realizar venta",color:"positive",class:"full-width","no-caps":"",loading:l.loading,type:"submit"},null,8,["loading"])])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),n(P,{modelValue:l.loteDialog,"onUpdate:modelValue":t[18]||(t[18]=o=>l.loteDialog=o),persistent:""},{default:a(()=>[n(y,{style:{"max-width":"700px",width:"90vw"}},{default:a(()=>[n(f,{class:"row items-center q-pb-none"},{default:a(()=>[t[27]||(t[27]=e("div",{class:"text-h6"},"Seleccionar lote",-1)),n(D),n(h,{flat:"",round:"",dense:"",icon:"close",onClick:t[16]||(t[16]=o=>l.loteDialog=!1)})]),_:1}),n(f,null,{default:a(()=>{var o;return[e("div",De,[t[28]||(t[28]=b(" Producto: ")),e("b",null,s(i.$filters.textUpper(((o=l.loteProducto)==null?void 0:o.nombre)||"")),1)]),n(k,{dense:"",flat:"",bordered:"","wrap-cells":""},{default:a(()=>[t[31]||(t[31]=e("thead",null,[e("tr",null,[e("th",null,"#"),e("th",null,"Lote"),e("th",null,"Vencimiento"),e("th",null,"Disponible"),e("th",null,"Elegir")])],-1)),e("tbody",null,[l.lotesLoading?(p(),m("tr",we,t[29]||(t[29]=[e("td",{colspan:"6",class:"text-center"},"Cargando\u2026",-1)]))):I("",!0),(p(!0),m(_,null,V(l.lotes,(c,g)=>(p(),m("tr",{key:c.id},[e("td",null,s(g+1),1),e("td",null,s(c.lote||"\u2014"),1),e("td",null,s(c.fecha_vencimiento||"\u2014"),1),e("td",Se,s(c.disponible),1),e("td",null,[n(h,{size:"xs",color:"primary",flat:"","no-caps":"",label:"Elegir",onClick:S=>u.onPickLote(c)},null,8,["onClick"])])]))),128)),!l.lotesLoading&&l.lotes.length===0?(p(),m("tr",Ce,t[30]||(t[30]=[e("td",{colspan:"6",class:"text-center text-negative"},"Sin lotes disponibles",-1)]))):I("",!0)])]),_:1}),l.loteSelected?(p(),m("div",Ne,[e("div",Ie,[n(v,{modelValue:l.loteCantidad,"onUpdate:modelValue":t[17]||(t[17]=c=>l.loteCantidad=c),modelModifiers:{number:!0},type:"number",dense:"",outlined:"",label:"Cantidad a vender",min:1,max:Number(l.loteSelected.disponible||0)},null,8,["modelValue","max"])]),e("div",ke,[e("div",null,[e("div",null,[t[32]||(t[32]=e("b",null,"Lote:",-1)),b(" "+s(l.loteSelected.lote||"\u2014"),1)]),e("div",null,[t[33]||(t[33]=e("b",null,"Vence:",-1)),b(" "+s(l.loteSelected.fecha_vencimiento||"\u2014"),1)])])]),e("div",Pe,[n(h,{color:"primary",icon:"add_shopping_cart",label:"Agregar a venta","no-caps":"",onClick:u.confirmarLote},null,8,["onClick"])])])):I("",!0)]}),_:1})]),_:1})]),_:1},8,["modelValue"]),t[34]||(t[34]=e("div",{id:"myElement",class:"hidden"},null,-1))]),_:1})}var Xe=U(A,[["render",Te]]);export{Xe as default};
