import{_ as U,O as p,P as q,Q as a,R as n,aH as v,T as e,S as h,aF as f,X as m,Y as x,Z as V,U as s,aG as _,J as S,bd as C,aI as P,V as y,W as N,$ as Q}from"./index.ee5ea1ee.js";import{Q as D}from"./QSpace.52b6e6a9.js";import{Q as L}from"./QPagination.d41289b3.js";import{Q as T}from"./QImg.3fa13a10.js";import{Q as I}from"./QMarkupTable.c742da6a.js";import{Q as E}from"./QForm.5a738a52.js";import{Q as k}from"./QSelect.1b05adbe.js";import{Q as R}from"./QPage.259aa5d6.js";import{I as B}from"./Imprimir.0807fac0.js";import"./format.2cae61da.js";import"./QChip.a003d209.js";import"./QMenu.171e731c.js";import"./moment.40bc58bf.js";const F={name:"VentasNew",data(){return{codigoTipoDocumentoIdentidades:[{value:1,label:"CI - CEDULA DE IDENTIDAD"},{value:2,label:"CEX - CED ULA DE IDENTIDAD DE EXTRANJERO"},{value:5,label:"NIT - N\xDAMERO DE IDENTIFICACI\xD3N TRIBUTARIA"},{value:3,label:"PAS - PASAPORTE"},{value:4,label:"OD - OTRO DOCUMENTO DE IDENTIDAD"}],loading:!1,ventaDialog:!1,efectivo:"",venta:{nit:"0",nombre:"SN",codigoTipoDocumentoIdentidad:1,tipo_venta:"Interno",tipo_pago:"Efectivo"},pagination:{page:1,rowsPerPage:24,rowsNumber:0},receta_id:null,recognition:null,activeField:null,productos:[],productosSearch:"",productosVentas:[],loteDialog:!1,lotesLoading:!1,lotes:[],loteSelected:null,loteCantidad:1,lotePrecio:0,loteProducto:null}},mounted(){if(this.$nextTick(()=>{var o;(o=this.$refs.inputBuscarProducto)==null||o.focus()}),this.productosGet(),"webkitSpeechRecognition"in window||"SpeechRecognition"in window){const o=window.SpeechRecognition||window.webkitSpeechRecognition;this.recognition=new o,this.recognition.lang="es-ES",this.recognition.interimResults=!1,this.recognition.continuous=!1,this.recognition.onresult=t=>{const d=t.results[0][0].transcript;this.activeField&&(this.venta[this.activeField]+=d)},this.recognition.onerror=t=>{console.error("Error en reconocimiento de voz:",t.error)}}},methods:{async openLoteDialog(o){var t,d;this.loteProducto=o,this.loteDialog=!0,this.lotes=[],this.lotesLoading=!0;try{const r=await this.$axios.get(`productos/${o.id}/historial-compras-ventas`);this.lotes=r.data||[],this.lotes.length===1&&this.onPickLote(this.lotes[0])}catch(r){console.error(r),(d=(t=this.$alert)==null?void 0:t.error)!=null&&d.call(t,"No se pudieron cargar los lotes")||this.$q.notify({type:"negative",message:"No se pudieron cargar los lotes"}),this.loteDialog=!1}finally{this.lotesLoading=!1}},onPickLote(o){var t,d,r;this.loteSelected=o,this.lotePrecio=Number((r=(d=o==null?void 0:o.precio_venta)!=null?d:(t=this.loteProducto)==null?void 0:t.precio)!=null?r:0),this.loteCantidad=1},confirmarLote(){var d,r,l,u;if(!this.loteSelected){(r=(d=this.$alert)==null?void 0:d.error)!=null&&r.call(d,"Selecciona un lote")||this.$q.notify({type:"negative",message:"Selecciona un lote"});return}const o=Number(this.loteSelected.disponible||0),t=Number(this.loteCantidad||0);if(t<=0||t>o){(u=(l=this.$alert)==null?void 0:l.error)!=null&&u.call(l,"Cantidad inv\xE1lida para el lote")||this.$q.notify({type:"negative",message:"Cantidad inv\xE1lida para el lote"});return}Number(this.lotePrecio||0),this.productosVentas.push({producto_id:this.loteProducto.id,cantidad:t,precio:this.loteProducto.precio,producto:this.loteProducto,compra_detalle_id:this.loteSelected.id,lote:this.loteSelected.lote,fecha_vencimiento:this.loteSelected.fecha_vencimiento}),this.loteDialog=!1,this.loteSelected=null,this.loteProducto=null,this.loteCantidad=1,this.lotePrecio=0},searchCliente(){this.loading=!0,this.$axios.post("searchCliente",{nit:this.venta.nit}).then(o=>{this.venta.nombre="SN",this.venta.email="",this.venta.codigoTipoDocumentoIdentidad=1,o.data.nombre&&(this.venta.nombre=o.data.nombre),o.data.email&&(this.venta.email=o.data.email),o.data.codigoTipoDocumentoIdentidad&&(this.venta.codigoTipoDocumentoIdentidad=parseInt(o.data.codigoTipoDocumentoIdentidad)),o.data.complemento&&(this.venta.complemento=o.data.complemento)}).catch(o=>console.error(o)).finally(()=>this.loading=!1)},clickDialogVenta(){var o,t;if(this.productosVentas.length===0){(t=(o=this.$alert)==null?void 0:o.error)!=null&&t.call(o,"Debe agregar al menos un producto a la venta")||this.$q.notify({type:"negative",message:"Debe agregar al menos un producto a la venta"});return}this.ventaDialog=!0,this.efectivo=""},productosGet(){this.loading=!0,this.$axios.get("productosCantidad",{params:{search:this.productosSearch,page:this.pagination.page,per_page:this.pagination.rowsPerPage}}).then(o=>{this.productos=o.data.data,this.pagination.rowsNumber=o.data.total,this.pagination.page=o.data.current_page,this.productos.length===1&&this.productos[0].barra===this.productosSearch&&(this.openLoteDialog(this.productos[0]),this.productosSearch="")}).catch(o=>{console.error(o)}).finally(()=>{this.loading=!1})},submitVenta(){this.loading=!0,this.$axios.post("ventas",{ci:this.venta.nit,nombre:this.venta.nombre,email:this.venta.email,codigoTipoDocumentoIdentidad:this.venta.codigoTipoDocumentoIdentidad,complemento:this.venta.complemento,productos:this.productosVentas,tipo_venta:this.venta.tipo_venta,tipo_pago:this.venta.tipo_pago,receta_id:this.receta_id}).then(o=>{var t,d;this.ventaDialog=!1,(d=(t=this.$alert)==null?void 0:t.success)==null||d.call(t,"Venta realizada con \xE9xito"),this.productosVentas=[],this.venta={nit:"0",nombre:"SN",codigoTipoDocumentoIdentidad:1,tipo_venta:"Interno",tipo_pago:"Efectivo"},B.reciboVentaSimple(o.data),this.receta_id=null,this.$nextTick(()=>{var r;return(r=this.$refs.inputBuscarProducto)==null?void 0:r.focus()}),this.productosGet()}).catch(o=>{var t,d,r,l;console.error(o),(l=(t=this.$alert)==null?void 0:t.error)==null||l.call(t,((r=(d=o==null?void 0:o.response)==null?void 0:d.data)==null?void 0:r.message)||"No se pudo realizar la venta")}).finally(()=>{this.loading=!1})},startRecognition(o){this.recognition?(this.activeField=o,this.recognition.start()):this.$q.notify({color:"negative",message:"El reconocimiento de voz no est\xE1 soportado en este navegador"})}},computed:{totalVenta(){return this.productosVentas.reduce((o,t)=>o+Number(t.cantidad)*Number(t.precio),0)},cambio(){let o=Number(this.efectivo||0)-this.totalVenta;return o<0&&(o=0),o.toFixed(2)}}},A={class:"row"},z={class:"col-12 col-md-7 q-pa-xs"},O={class:"flex flex-center"},G={class:"row"},M={class:"absolute-bottom text-center",style:{padding:"0",margin:"0"}},X={style:{"max-width":"190px","line-height":"0.9"}},J={style:{display:"flex","justify-content":"space-between"}},j={class:"text-bold bg-orange text-black border"},H={class:"col-12 col-md-5 q-pa-xs"},W={class:"text-right flex items-center"},Y={style:{padding:"0",margin:"0",display:"flex","align-items":"center"}},Z={style:{"max-width":"190px",overflow:"hidden","text-overflow":"ellipsis","line-height":".9"}},K={style:{padding:"0",margin:"0"}},$=["onUpdate:modelValue"],ee={style:{padding:"0",margin:"0"}},te=["onUpdate:modelValue"],oe={class:"text-right"},le={class:"text-right text-bold"},ie={class:"row"},ne={class:"col-12 col-md-3 q-pa-xs"},se={class:"col-12 col-md-3 q-pa-xs"},ae={class:"col-12 col-md-3 q-pa-xs"},de={class:"col-12 col-md-3 q-pa-xs"},re={class:"col-12 col-md-3 q-pa-xs"},ue={class:"col-12 col-md-3 q-pa-xs"},ce={class:"col-12 col-md-6 q-pa-xs"},pe={class:"col-12 q-pa-xs"},me={style:{padding:"0",margin:"0"}},he={style:{"max-width":"190px",overflow:"hidden","text-overflow":"ellipsis","line-height":".9"}},ge={class:"text-right"},ve={class:"text-right text-bold"},fe={class:"text-right"},be={class:"text-right"},xe={class:"col-12 q-pa-xs"},Ve={class:"q-mb-sm text-subtitle2"},_e={key:0},ye={class:"text-right"},De={key:1},we={key:0,class:"row q-col-gutter-sm q-mt-sm"},Se={class:"col-12 col-md-4"},Ce={class:"col-12 col-md-4"},Ne={class:"col-12 col-md-4 flex items-end"};function Ie(o,t,d,r,l,u){return p(),q(R,{class:"q-pa-xs"},{default:a(()=>[n(_,{flat:"",bordered:""},{default:a(()=>[n(v,{class:"row items-center q-pb-none"},{default:a(()=>[t[17]||(t[17]=e("div",{class:"text-h6"},"Ventas",-1)),n(h,{flat:"",round:"",dense:"",icon:"arrow_back",onClick:t[0]||(t[0]=i=>o.$router.go(-1))}),n(h,{flat:"",round:"",dense:"",icon:"refresh",onClick:u.productosGet,loading:l.loading},null,8,["onClick","loading"]),n(D)]),_:1}),n(v,{class:"q-pa-none"},{default:a(()=>[n(E,{onSubmit:u.clickDialogVenta},{default:a(()=>[e("div",A,[e("div",z,[n(f,{ref:"inputBuscarProducto",modelValue:l.productosSearch,"onUpdate:modelValue":[t[1]||(t[1]=i=>l.productosSearch=i),u.productosGet],outlined:"",clearable:"",label:"Buscar producto",dense:"",debounce:"300"},{append:a(()=>[n(h,{flat:"",round:"",dense:"",icon:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"]),e("div",O,[n(L,{size:"xs",modelValue:l.pagination.page,"onUpdate:modelValue":[t[2]||(t[2]=i=>l.pagination.page=i),u.productosGet],max:Math.ceil(l.pagination.rowsNumber/l.pagination.rowsPerPage),color:"primary","boundary-numbers":"","max-pages":"5"},null,8,["modelValue","max","onUpdate:modelValue"])]),e("div",G,[(p(!0),m(V,null,x(l.productos,i=>(p(),m("div",{key:i.id,class:"col-6 col-md-2"},[n(_,{flat:"",bordered:"",class:"cursor-pointer",onClick:c=>u.openLoteDialog(i)},{default:a(()=>[n(T,{src:`${o.$url}../images/${i.imagen}`,class:"q-mb-xs",style:{height:"120px"}},{default:a(()=>[e("div",M,[e("div",X,s(o.$filters.textUpper(i.nombre)),1),e("div",J,[e("span",null,s(i.cantidad),1),e("span",j,s(i.precio)+" Bs",1)])])]),_:2},1032,["src"])]),_:2},1032,["onClick"])]))),128))])]),e("div",H,[e("div",W,[n(D),n(h,{icon:"delete",size:"10px",color:"red",dense:"",flat:"","no-caps":"",label:"Limpiar",onClick:t[3]||(t[3]=i=>{l.productosVentas=[],l.receta_id=null})})]),n(I,{dense:"","wrap-cells":"",flat:"",bordered:""},{default:a(()=>[t[19]||(t[19]=e("thead",null,[e("tr",null,[e("th",null,"Producto"),e("th",null,"Lote"),e("th",null,"Vence"),e("th",null,"Cantidad"),e("th",null,"Precio"),e("th",null,"Subtotal")])],-1)),e("tbody",null,[(p(!0),m(V,null,x(l.productosVentas,(i,c)=>{var g,w;return p(),m("tr",{key:c},[e("td",Y,[n(T,{src:`${o.$url}../images/${(g=i.producto)==null?void 0:g.imagen}`,class:"q-mb-xs",style:{height:"35px",width:"35px"}},null,8,["src"]),e("div",Z,[n(Q,{name:"delete",color:"red",class:"cursor-pointer",onClick:b=>l.productosVentas.splice(c,1)},null,8,["onClick"]),y(" "+s(o.$filters.textUpper((w=i.producto)==null?void 0:w.nombre)),1)])]),e("td",null,s(i.lote||"\u2014"),1),e("td",null,s(i.fecha_vencimiento||"\u2014"),1),e("td",K,[S(e("input",{"onUpdate:modelValue":b=>i.cantidad=b,type:"number",style:{width:"60px"},min:"1"},null,8,$),[[C,i.cantidad,void 0,{number:!0}]])]),e("td",ee,[S(e("input",{"onUpdate:modelValue":b=>i.precio=b,type:"number",style:{width:"70px"},step:"0.01"},null,8,te),[[C,i.precio,void 0,{number:!0}]])]),e("td",oe,s((Number(i.cantidad)*Number(i.precio)).toFixed(2))+" Bs ",1)])}),128))]),e("tfoot",null,[e("tr",null,[t[18]||(t[18]=e("td",{colspan:"5",class:"text-right text-bold"},"Total",-1)),e("td",le,s(u.totalVenta.toFixed(2))+" Bs ",1)])])]),_:1}),n(h,{label:"Realizar venta",color:"positive",class:"full-width","no-caps":"",loading:l.loading,type:"submit",icon:"add_circle_outline"},null,8,["loading"])])])]),_:1},8,["onSubmit"])]),_:1})]),_:1}),n(P,{modelValue:l.ventaDialog,"onUpdate:modelValue":t[13]||(t[13]=i=>l.ventaDialog=i)},{default:a(()=>[n(_,{style:{"max-width":"750px",width:"90vw"}},{default:a(()=>[n(v,{class:"q-pb-none row items-center"},{default:a(()=>[t[20]||(t[20]=e("div",{class:"text-h6"},"Nueva venta",-1)),n(D),n(h,{flat:"",round:"",dense:"",icon:"close",onClick:t[4]||(t[4]=i=>l.ventaDialog=!1)})]),_:1}),n(v,null,{default:a(()=>[n(E,{onSubmit:u.submitVenta},{default:a(()=>[e("div",ie,[e("div",ne,[n(f,{modelValue:l.venta.nit,"onUpdate:modelValue":[t[5]||(t[5]=i=>l.venta.nit=i),u.searchCliente],outlined:"",dense:"",label:"CI/NIT",debounce:500},null,8,["modelValue","onUpdate:modelValue"])]),e("div",se,[n(f,{modelValue:l.venta.nombre,"onUpdate:modelValue":t[6]||(t[6]=i=>l.venta.nombre=i),outlined:"",dense:"",label:"Nombre"},null,8,["modelValue"])]),e("div",ae,[n(f,{modelValue:l.venta.email,"onUpdate:modelValue":t[7]||(t[7]=i=>l.venta.email=i),outlined:"",dense:"",label:"Email"},null,8,["modelValue"])]),e("div",de,[n(k,{modelValue:l.venta.tipo_venta,"onUpdate:modelValue":t[8]||(t[8]=i=>l.venta.tipo_venta=i),outlined:"",dense:"",label:"Tipo de venta",options:["Interno","Externo"]},null,8,["modelValue"])]),e("div",re,[n(f,{modelValue:l.venta.complemento,"onUpdate:modelValue":t[9]||(t[9]=i=>l.venta.complemento=i),outlined:"",dense:"",label:"Complemento"},null,8,["modelValue"])]),e("div",ue,[n(k,{modelValue:l.venta.tipo_pago,"onUpdate:modelValue":t[10]||(t[10]=i=>l.venta.tipo_pago=i),outlined:"",dense:"",label:"Tipo de pago",options:["Efectivo","QR"]},null,8,["modelValue"])]),e("div",ce,[n(k,{modelValue:l.venta.codigoTipoDocumentoIdentidad,"onUpdate:modelValue":t[11]||(t[11]=i=>l.venta.codigoTipoDocumentoIdentidad=i),outlined:"",dense:"",label:"Tipo de documento",options:l.codigoTipoDocumentoIdentidades,"emit-value":"","map-options":""},null,8,["modelValue","options"])]),e("div",pe,[n(I,{dense:"","wrap-cells":"",flat:"",bordered:""},{default:a(()=>[t[24]||(t[24]=e("thead",null,[e("tr",null,[e("th",null,"ID"),e("th",null,"Producto"),e("th",null,"Lote"),e("th",null,"Vence"),e("th",null,"Cant."),e("th",null,"Precio"),e("th",null,"Subtotal")])],-1)),e("tbody",null,[(p(!0),m(V,null,x(l.productosVentas,(i,c)=>{var g;return p(),m("tr",{key:"prev-"+c},[e("td",null,s(i.producto_id),1),e("td",me,[e("div",he,s(o.$filters.textUpper(((g=i.producto)==null?void 0:g.nombre)||"")),1)]),e("td",null,s(i.lote||"\u2014"),1),e("td",null,s(i.fecha_vencimiento||"\u2014"),1),e("td",null,s(i.cantidad),1),e("td",null,s(Number(i.precio).toFixed(2))+" Bs",1),e("td",ge,s((Number(i.cantidad)*Number(i.precio)).toFixed(2))+" Bs ",1)])}),128))]),e("tfoot",null,[e("tr",null,[t[21]||(t[21]=e("td",{colspan:"6",class:"text-right text-bold"},"Total",-1)),e("td",ve,s(u.totalVenta.toFixed(2))+" Bs",1)]),e("tr",null,[t[22]||(t[22]=e("td",{colspan:"6",class:"text-right text-bold"},"Efectivo",-1)),e("td",fe,[S(e("input",{"onUpdate:modelValue":t[12]||(t[12]=i=>l.efectivo=i),type:"number",step:"0.01",style:{width:"100px"}},null,512),[[C,l.efectivo,void 0,{number:!0}]])])]),e("tr",null,[t[23]||(t[23]=e("td",{colspan:"6",class:"text-right text-bold"},"Cambio",-1)),e("td",be,s(u.cambio),1)])])]),_:1})]),e("div",xe,[n(h,{label:"Realizar venta",color:"positive",class:"full-width","no-caps":"",loading:l.loading,type:"submit"},null,8,["loading"])])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),n(P,{modelValue:l.loteDialog,"onUpdate:modelValue":t[16]||(t[16]=i=>l.loteDialog=i),persistent:""},{default:a(()=>[n(_,{style:{"max-width":"700px",width:"90vw"}},{default:a(()=>[n(v,{class:"row items-center q-pb-none"},{default:a(()=>[t[25]||(t[25]=e("div",{class:"text-h6"},"Seleccionar lote",-1)),n(D),n(h,{flat:"",round:"",dense:"",icon:"close",onClick:t[14]||(t[14]=i=>l.loteDialog=!1)})]),_:1}),n(v,null,{default:a(()=>{var i;return[e("div",Ve,[t[26]||(t[26]=y(" Producto: ")),e("b",null,s(o.$filters.textUpper(((i=l.loteProducto)==null?void 0:i.nombre)||"")),1)]),n(I,{dense:"",flat:"",bordered:"","wrap-cells":""},{default:a(()=>[t[29]||(t[29]=e("thead",null,[e("tr",null,[e("th",null,"#"),e("th",null,"Lote"),e("th",null,"Vencimiento"),e("th",null,"Disponible"),e("th",null,"Elegir")])],-1)),e("tbody",null,[l.lotesLoading?(p(),m("tr",_e,t[27]||(t[27]=[e("td",{colspan:"6",class:"text-center"},"Cargando\u2026",-1)]))):N("",!0),(p(!0),m(V,null,x(l.lotes,(c,g)=>(p(),m("tr",{key:c.id},[e("td",null,s(g+1),1),e("td",null,s(c.lote||"\u2014"),1),e("td",null,s(c.fecha_vencimiento||"\u2014"),1),e("td",ye,s(c.disponible),1),e("td",null,[n(h,{size:"xs",color:"primary",flat:"","no-caps":"",label:"Elegir",onClick:w=>u.onPickLote(c)},null,8,["onClick"])])]))),128)),!l.lotesLoading&&l.lotes.length===0?(p(),m("tr",De,t[28]||(t[28]=[e("td",{colspan:"6",class:"text-center text-negative"},"Sin lotes disponibles",-1)]))):N("",!0)])]),_:1}),l.loteSelected?(p(),m("div",we,[e("div",Se,[n(f,{modelValue:l.loteCantidad,"onUpdate:modelValue":t[15]||(t[15]=c=>l.loteCantidad=c),modelModifiers:{number:!0},type:"number",dense:"",outlined:"",label:"Cantidad a vender",min:1,max:Number(l.loteSelected.disponible||0)},null,8,["modelValue","max"])]),e("div",Ce,[e("div",null,[e("div",null,[t[30]||(t[30]=e("b",null,"Lote:",-1)),y(" "+s(l.loteSelected.lote||"\u2014"),1)]),e("div",null,[t[31]||(t[31]=e("b",null,"Vence:",-1)),y(" "+s(l.loteSelected.fecha_vencimiento||"\u2014"),1)])])]),e("div",Ne,[n(h,{color:"primary",icon:"add_shopping_cart",label:"Agregar a venta","no-caps":"",onClick:u.confirmarLote},null,8,["onClick"])])])):N("",!0)]}),_:1})]),_:1})]),_:1},8,["modelValue"]),t[32]||(t[32]=e("div",{id:"myElement",class:"hidden"},null,-1))]),_:1})}var Oe=U(F,[["render",Ie]]);export{Oe as default};
