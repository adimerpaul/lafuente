import{_ as S,O as c,P as v,Q as a,T as l,R as e,aH as _,$ as p,V as u,U as i,aG as g,aF as E,S as V,J as b,X as k,Y as N,Z as I,aI as q,as as w,W as z}from"./index.ff2088a8.js";import{a as f,b as r}from"./QMenu.faa41e22.js";import{Q as x}from"./QItemLabel.7dd7b0cb.js";import{Q as B}from"./QSelect.68f1116b.js";import{Q as T}from"./QBtnDropdown.34108916.js";import{Q as y}from"./QChip.ae77b139.js";import{Q as A}from"./QMarkupTable.5c8d9dea.js";import{Q as P}from"./QSpace.64fd9aea.js";import{Q as G}from"./QPage.fb0af69d.js";import{C}from"./ClosePopup.0cfc3b03.js";import{h as F}from"./moment.40bc58bf.js";import{I as U}from"./Imprimir.c677c052.js";import{E as Y}from"./Excel.a5e16faf.js";import"./format.2cae61da.js";import"./QBtnGroup.c3618af2.js";import"./_commonjsHelpers.a26ce4be.js";const $={name:"Ventas",data(){return{ventas:[],venta:{},ventaDialog:!1,fechaInicio:F().format("YYYY-MM-DD"),fechaFin:F().format("YYYY-MM-DD"),loading:!1,actionPeriodo:"",gestiones:[],users:[],user:"",filter:"",roles:["Doctor","Enfermera","Administrativo","Secretaria"],columns:[{name:"actions",label:"Acciones",align:"center"},{name:"nombre",label:"Nombre",align:"left",field:"nombre"},{name:"descripcion",label:"Descripci\xF3n",align:"left",field:"descripcion"},{name:"unidad",label:"Unidad",align:"left",field:"unidad"},{name:"precio",label:"Precio",align:"left",field:"precio"},{name:"stock",label:"Stock",align:"left",field:"stock"},{name:"stock_minimo",label:"Stock m\xEDnimo",align:"left",field:"stock_minimo"},{name:"stock_maximo",label:"Stock m\xE1ximo",align:"left",field:"stock_maximo"}],devDialog:!1,devVentaId:null,devItems:[]}},mounted(){this.ventasGet(),this.usersGet()},methods:{devolverProducto(s,t,m){this.$q.dialog({title:"Devolver producto",message:`Ingrese la cantidad a devolver (vendido: ${m}):`,prompt:{model:m,type:"number",isValid:D=>{const n=Number(D);return!isNaN(n)&&n>0&&n<=m},label:"Cantidad a devolver",hint:`Debe ser un n\xFAmero entre 1 y ${m}`,mask:"##########"},cancel:!0,persistent:!0}).onOk(D=>{const n=Number(D);if(isNaN(n)||n<=0||n>m){this.$alert.error("Cantidad inv\xE1lida");return}this.$axios.post("ventasDevolverProducto",{venta_id:s,venta_detalle_id:t,cantidad:n}).then(d=>{this.$alert.success("Producto devuelto correctamente"),this.devDialog=!1,this.ventasGet()}).catch(d=>{this.$alert.error(d.response.data.message)})})},openDevolver(s){this.venta=s,this.devDialog=!0},exportExcel(){const s=(this.ventas||[]).filter(m=>String(m.estado).toLowerCase()==="activo");if(s.length===0){this.$q.notify({type:"warning",message:"No hay ventas ACTIVAS para exportar"});return}const t=[{columns:[{label:"ID",value:"id"},{label:"Fecha",value:"fecha"},{label:"Cliente",value:"cliente.nombre"},{label:"Usuario",value:"user.name"},{label:"Estado",value:"estado"},{label:"Total",value:"total"},{label:"Detalle",value:"detailsText"},{label:"Tipo venta",value:"tipo_venta"}],content:s}];Y.export(t,"Ventas_Activas")},usersGet(){this.$axios.get("users").then(s=>{this.users=s.data}).catch(s=>{this.$alert.error(s.response.data.message)})},imprimir(s){U.reciboVentaSimple(s)},tipoVentasChange(s){this.$axios.put(`tipoVentasChange/${s}`).then(t=>{this.$alert.success("Tipo de venta cambiado"),this.ventasGet()}).catch(t=>{this.$alert.error(t.response.data.message)})},anular(s){this.$alert.dialog("\xBFEst\xE1 seguro de anular la venta?").onOk(()=>{this.$axios.put(`ventasAnular/${s}`).then(t=>{this.$alert.success("Venta anulada"),this.ventasGet()}).catch(t=>{this.$alert.error(t.response.data.message)})})},ventasGet(){this.loading=!0,this.$axios.get("ventas",{params:{fechaInicio:this.fechaInicio,fechaFin:this.fechaFin,user:this.user}}).then(s=>{this.ventas=s.data}).catch(s=>{this.$alert.error(s.response.data.message)}).finally(()=>{this.loading=!1})}},computed:{usersTodos(){return[{label:"Todos",value:""},...this.users.map(s=>({label:s.name,value:s.id}))]},totalInternos(){return this.ventas.reduce((s,t)=>t.tipo_venta==="Internado"&&t.estado==="Activo"?s+parseFloat(t.total):s,0)},totalExternos(){return this.ventas.reduce((s,t)=>t.tipo_venta==="Externo"&&t.estado==="Activo"?s+parseFloat(t.total):s,0)}}},M={class:"row"},L={class:"col-12 col-md-4 q-pa-xs"},O={class:"col-12 col-md-4 q-pa-xs"},R={class:"col-12 col-md-4 q-pa-xs"},H={class:"col-12"},J={class:"row"},W={class:"col-12 col-md-2"},X={class:"col-12 col-md-2"},Z={class:"col-12 col-md-2"},j={class:"col-12 col-md-2"},K={class:"col-12 col-md-2 text-right"},ee={class:"col-12 col-md-2 text-right"},te={class:"text-bold"},le={style:{"max-width":"200px","wrap-option":"wrap","line-height":"0.9"}},ae={class:"text-center"},oe={style:{"max-width":"360px",overflow:"hidden","text-overflow":"ellipsis"}},se={class:"text-center"},ne={class:"text-center"},ie={class:"text-center"};function re(s,t,m,D,n,d){return c(),v(G,{class:"q-pa-xs"},{default:a(()=>[l("div",M,[l("div",L,[e(g,{flat:"",bordered:""},{default:a(()=>[e(_,{class:"q-pa-none"},{default:a(()=>[e(f,{class:"bg-indigo"},{default:a(()=>[e(r,{avatar:""},{default:a(()=>[e(p,{name:"monetization_on",size:"50px",color:"white"})]),_:1}),e(r,null,{default:a(()=>[e(x,{caption:"",class:"text-white"},{default:a(()=>t[6]||(t[6]=[u("Ventas Interno")])),_:1}),e(x,{class:"text-white text-h4"},{default:a(()=>[u(i(d.totalInternos)+" Bs",1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),l("div",O,[e(g,{flat:"",bordered:""},{default:a(()=>[e(_,{class:"q-pa-none"},{default:a(()=>[e(f,{class:"bg-orange"},{default:a(()=>[e(r,{avatar:""},{default:a(()=>[e(p,{name:"monetization_on",size:"50px",color:"white"})]),_:1}),e(r,null,{default:a(()=>[e(x,{caption:"",class:"text-white"},{default:a(()=>t[7]||(t[7]=[u("Ventas Externo")])),_:1}),e(x,{class:"text-white text-h4"},{default:a(()=>[u(i(d.totalExternos)+" Bs",1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),l("div",R,[e(g,{flat:"",bordered:""},{default:a(()=>[e(_,{class:"q-pa-none"},{default:a(()=>[e(f,{class:"bg-green"},{default:a(()=>[e(r,{avatar:""},{default:a(()=>[e(p,{name:"monetization_on",size:"50px",color:"white"})]),_:1}),e(r,null,{default:a(()=>[e(x,{caption:"",class:"text-white"},{default:a(()=>t[8]||(t[8]=[u("Ventas Total")])),_:1}),e(x,{class:"text-white text-h4"},{default:a(()=>[u(i(d.totalInternos+d.totalExternos)+" Bs",1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),l("div",H,[e(g,{flat:"",bordered:""},{default:a(()=>[e(_,{class:"q-pa-none"},{default:a(()=>[l("div",J,[l("div",W,[e(E,{modelValue:n.fechaInicio,"onUpdate:modelValue":t[0]||(t[0]=o=>n.fechaInicio=o),label:"Fecha inicio",dense:"",outlined:"",type:"date"},null,8,["modelValue"])]),l("div",X,[e(E,{modelValue:n.fechaFin,"onUpdate:modelValue":t[1]||(t[1]=o=>n.fechaFin=o),label:"Fecha fin",dense:"",outlined:"",type:"date"},null,8,["modelValue"])]),l("div",Z,[e(B,{modelValue:n.user,"onUpdate:modelValue":t[2]||(t[2]=o=>n.user=o),options:d.usersTodos,label:"Usuario",dense:"",outlined:"","emit-value":"","map-options":""},null,8,["modelValue","options"])]),l("div",j,[e(V,{color:"primary",label:"Buscar","no-caps":"",icon:"search",loading:n.loading,onClick:t[3]||(t[3]=o=>d.ventasGet())},null,8,["loading"])]),l("div",K,[e(T,{color:"primary",label:"Exportar","no-caps":""},{default:a(()=>[b((c(),v(f,{clickable:"",onClick:d.exportExcel},{default:a(()=>[e(r,{avatar:""},{default:a(()=>[e(p,{name:"file_download"})]),_:1}),e(r,null,{default:a(()=>t[9]||(t[9]=[u("Excel")])),_:1})]),_:1},8,["onClick"])),[[w],[C]])]),_:1})]),l("div",ee,[e(V,{color:"positive",label:"Nueva venta","no-caps":"",icon:"add_circle_outline",loading:n.loading,to:"/ventaNuevo"},null,8,["loading"])])])]),_:1})]),_:1})])]),e(A,{dense:"","wrap-cells":""},{default:a(()=>[t[13]||(t[13]=l("thead",null,[l("tr",{class:"bg-primary text-white"},[l("th",null,"Acciones"),l("th",null,"ID"),l("th",null,"Fecha"),l("th",null,"Cliente"),l("th",null,"Usuario"),l("th",null,"Estado"),l("th",null,"Total"),l("th",null,"Detalle"),l("th",null,"Tipo venta")])],-1)),l("tbody",null,[n.ventas.length!=0?(c(!0),k(I,{key:0},N(n.ventas,(o,Q)=>(c(),k("tr",{key:o.id},[l("td",null,[e(T,{color:"primary",label:"Opciones","no-caps":"",dense:"",size:"10px"},{default:a(()=>[b((c(),v(f,{clickable:"",onClick:h=>d.imprimir(o)},{default:a(()=>[e(r,{avatar:""},{default:a(()=>[e(p,{name:"print"})]),_:1}),e(r,null,{default:a(()=>t[10]||(t[10]=[u("Imprimir")])),_:1})]),_:2},1032,["onClick"])),[[w],[C]]),b((c(),v(f,{clickable:"",onClick:h=>d.anular(o.id)},{default:a(()=>[e(r,{avatar:""},{default:a(()=>[e(p,{name:"delete"})]),_:1}),e(r,null,{default:a(()=>t[11]||(t[11]=[u("Anular")])),_:1})]),_:2},1032,["onClick"])),[[w],[C]]),b((c(),v(f,{clickable:"",onClick:h=>d.tipoVentasChange(o.id)},{default:a(()=>[e(r,{avatar:""},{default:a(()=>[e(p,{name:"swap_horiz"})]),_:1}),e(r,null,{default:a(()=>[u("Cambiar a "+i(o.tipo_venta==="Interno"?"Externo":"Interno"),1)]),_:2},1024)]),_:2},1032,["onClick"])),[[w],[C]]),o.estado==="Activo"?b((c(),v(f,{key:0,clickable:"",onClick:h=>d.openDevolver(o)},{default:a(()=>[e(r,{avatar:""},{default:a(()=>[e(p,{name:"undo"})]),_:1}),e(r,null,{default:a(()=>t[12]||(t[12]=[u("Devolver productos")])),_:1})]),_:2},1032,["onClick"])),[[w],[C]]):z("",!0)]),_:2},1024)]),l("td",null,i(o.id),1),l("td",null,i(o.fecha)+" "+i(o.hora),1),l("td",null,i(o.nombre),1),l("td",null,i(o.user.name),1),l("td",null,[e(y,{color:o.estado==="Activo"?"positive":"negative",class:"text-white",dense:""},{default:a(()=>[u(i(o.estado),1)]),_:2},1032,["color"])]),l("td",te,[u(i(o.total)+" ",1),e(y,{size:"10px",color:o.tipo_pago==="Efectivo"?"green":"blue",class:"text-white",dense:""},{default:a(()=>[u(i(o.tipo_pago.charAt(0)),1)]),_:2},1032,["color"])]),l("td",null,[l("div",le,i(o.detailsText),1)]),l("td",null,[e(y,{color:o.tipo_venta==="Internado"?"indigo":"orange",class:"text-white",dense:""},{default:a(()=>[u(i(o.tipo_venta),1)]),_:2},1032,["color"])])]))),128)):(c(),k(I,{key:1},[],64))])]),_:1}),e(q,{modelValue:n.devDialog,"onUpdate:modelValue":t[5]||(t[5]=o=>n.devDialog=o),persistent:""},{default:a(()=>[e(g,{style:{"max-width":"860px",width:"95vw"}},{default:a(()=>[e(_,{class:"row items-center q-pb-none"},{default:a(()=>[t[14]||(t[14]=l("div",{class:"text-h6"},"Devolver productos",-1)),e(P),e(V,{flat:"",round:"",dense:"",icon:"close",onClick:t[4]||(t[4]=o=>n.devDialog=!1)})]),_:1}),e(_,null,{default:a(()=>[e(A,{dense:"","wrap-cells":"",flat:"",bordered:""},{default:a(()=>[t[15]||(t[15]=l("thead",null,[l("tr",null,[l("th",null,"#"),l("th",null,"Producto"),l("th",null,"Lote"),l("th",null,"Vencimiento"),l("th",{style:{width:"100px"}},"Vendido"),l("th",{style:{width:"140px"}},"Devolver")])],-1)),l("tbody",null,[(c(!0),k(I,null,N(n.venta.venta_detalles,(o,Q)=>{var h;return c(),k("tr",{key:o.id},[l("td",ae,i(Q+1),1),l("td",oe,i(o.nombre||((h=o.producto)==null?void 0:h.nombre)||"\u2014"),1),l("td",se,i(o.lote||"\u2014"),1),l("td",ne,i(o.fecha_vencimiento||"\u2014"),1),l("td",ie,i(o.cantidad),1),l("td",null,[e(V,{size:"sm",color:"negative",label:"Devolver","no-caps":"",onClick:de=>d.devolverProducto(n.venta.id,o.id,o.cantidad),icon:"undo"},null,8,["onClick"])])])}),128))])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),t[16]||(t[16]=l("div",{id:"myElement",class:"hidden"},null,-1))]),_:1})}var Ie=S($,[["render",re]]);export{Ie as default};
