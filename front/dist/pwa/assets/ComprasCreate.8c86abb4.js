import{_ as N,O as u,P as Q,Q as n,R as s,aH as f,T as e,S as m,aF as h,X as b,Y as C,Z as V,U as p,aG as w,bm as I,aI as k,$ as E,V as S,J as g,bd as v,a2 as T}from"./index.91340ddf.js";import{Q as G}from"./QPagination.6b77af8b.js";import{Q as P}from"./QImg.93887be9.js";import{Q as F}from"./QMarkupTable.f2526c95.js";import{Q as D}from"./QForm.f0248f92.js";import{Q as U}from"./QSpace.1627839e.js";import{Q as q}from"./QSelect.4c70e5f1.js";import{Q as M}from"./QPage.4f16a01c.js";import{I as B}from"./Imprimir.5c23d6e9.js";import"./format.2cae61da.js";import"./QChip.ddf67662.js";import"./QMenu.3bda8529.js";import"./moment.40bc58bf.js";const R={name:"ComprasCreate",data(){return{proveedorDialog:!1,formProveedorRef:null,proveedorForm:{nombre:"",ci:"",telefono:"",email:"",direccion:""},loading:!1,compraDialog:!1,productos:[],productosSearch:"",productosCompras:[],proveedores:[],proveedor:null,compra:{nit:"",nombre:"",tipo_pago:"Efectivo"},pagination:{page:1,rowsPerPage:24,rowsNumber:0}}},computed:{totalCompra(){let r=0;return this.productosCompras.forEach(o=>{r+=o.cantidad*o.precio}),parseFloat(r).toFixed(2)}},methods:{openProveedorDialog(){this.resetProveedorForm(),this.proveedorDialog=!0},closeProveedorDialog(){this.proveedorDialog=!1},resetProveedorForm(){this.proveedorForm={nombre:"",ci:"",telefono:"",email:"",direccion:""}},async saveProveedor(){!await this.$refs.formProveedorRef.validate()||(this.loading=!0,this.$axios.post("proveedores",this.proveedorForm).then(o=>{var c,l;const a=o.data;this.proveedores.unshift(a),this.proveedor=a,this.compra.nombre=a.nombre||"",this.compra.ci=a.ci||"",(l=(c=this.$alert)==null?void 0:c.success)!=null&&l.call(c,"Proveedor creado correctamente")||this.$q.notify({type:"positive",message:"Proveedor creado correctamente"}),this.proveedorDialog=!1,this.resetProveedorForm()}).catch(o=>{var a,c;console.error("Error creando proveedor:",o),(c=(a=this.$alert)==null?void 0:a.error)!=null&&c.call(a,"No se pudo crear el proveedor")||this.$q.notify({type:"negative",message:"No se pudo crear el proveedor"})}).finally(()=>{this.loading=!1}))},onCantidadChange(r){const o=Number(r.cantidad)||0,a=Number(r.precio)||0;r.total=this.round2(o*a),this.updatePrecioVenta(r)},onPrecioChange(r){const o=Number(r.cantidad)||0,a=Number(r.precio)||0;r.total=this.round2(o*a),this.updatePrecioVenta(r)},onTotalChange(r){const o=Number(r.cantidad)||0,a=Number(r.total)||0;r.precio=o>0?this.round3(a/o):0,this.updatePrecioVenta(r)},onFactorChange(r){this.updatePrecioVenta(r)},updatePrecioVenta(r){const o=Number(r.precio)||0,a=Number(r.factor)||0;r.precio_venta=this.round2(o*a)},round2(r){return Math.round((Number(r)||0)*100)/100},round3(r){return Math.round((Number(r)||0)*1e3)/1e3},recuperarPedido(){this.$q.dialog({title:"Recuperar pedido",message:"Ingrese el ID del pedido",prompt:{model:"",type:"text",isValid:r=>!!r||"Campo requerido"},persistent:!0,cancel:!0,ok:{label:"Recuperar",color:"primary"}}).onOk(r=>{this.loading=!0,this.$axios.get("recuperarPedido",{params:{id:r}}).then(o=>{if(!o.data.detalles||o.data.detalles.length===0){this.$alert.error("No se encontraron productos en el pedido");return}o.data.detalles.forEach(a=>{const c=a.producto,l=this.productosCompras.find(d=>d.producto_id===c.id);l?l.cantidad+=1:this.productosCompras.push({producto_id:c.id,cantidad:parseInt(a.cantidad),precio:"",lote:"",fecha_vencimiento:"",producto:c,factor:1.25})})}).catch(o=>{console.error("Error recuperando pedido:",o)}).finally(()=>{this.loading=!1})})},updatePrecioVenta(r){const o=Math.ceil(r.precio*r.factor);r.precio_venta=o},productosGet(){this.loading=!0,this.$axios.get("productos",{params:{search:this.productosSearch,page:this.pagination.page,per_page:this.pagination.rowsPerPage}}).then(r=>{this.productos=r.data.data,this.pagination.rowsNumber=r.data.total}).catch(r=>{console.error("Error cargando productos:",r)}).finally(()=>{this.loading=!1})},addProducto(r){this.productosCompras.push({producto_id:r.id,cantidad:1,precio:"",lote:"",fecha_vencimiento:"",producto:r,factor:1.25})},clickDialogCompra(){if(this.productosCompras.length===0){this.$alert.error("Debe agregar al menos un producto");return}if(this.productosCompras.filter(o=>!o.precio).length>0){this.$alert.error("Todos los productos deben tener precio unitario");return}this.compraDialog=!0},buscarProveedor(){!this.compra.nit||(this.loading=!0,this.$axios.post("searchProveedor",{nit:this.compra.nit}).then(r=>{var o;(o=r.data)!=null&&o.nombre&&(this.compra.nombre=r.data.nombre)}).catch(r=>{console.warn("Proveedor no encontrado",r)}).finally(()=>{this.loading=!1}))},submitCompra(){this.loading=!0;const r={tipo_pago:this.compra.tipo_pago,proveedor_id:this.proveedor.id,nro_factura:this.compra.nro_factura,productos:this.productosCompras,agencia:this.compra.agencia};this.$axios.post("compras",r).then(o=>{this.$alert.success("Compra registrada correctamente"),this.compraDialog=!1,this.productosCompras=[],B.reciboCompra(o.data),this.productosGet(),this.compra={nit:"",nombre:"",tipo_pago:"Efectivo"},this.proveedor=null}).catch(o=>{console.error("Error registrando compra:",o),this.$alert.error("Error al registrar la compra")}).finally(()=>{})},proveedoresGet(){this.$axios.get("proveedores").then(r=>{this.proveedores=r.data}).catch(r=>{console.error("Error cargando proveedores:",r)}).finally(()=>{})}},mounted(){this.productosGet(),this.proveedoresGet()}},z={class:"row"},L={class:"col-12 col-md-5 q-pa-xs"},j={class:"flex flex-center"},O={class:"row"},H={class:"col-6 col-md-2"},J={class:"absolute-bottom text-center",style:{padding:"0",margin:"0"}},X={style:{"max-width":"190px","line-height":"0.9"}},Y={style:{display:"flex","justify-content":"space-between"}},Z={class:"text-bold bg-orange text-black border"},A={class:"col-12 col-md-7 q-pa-xs"},K={style:{display:"flex","align-items":"center","justify-content":"space-between"}},W={class:"pm-none",style:{display:"flex","align-items":"center"}},$={style:{"max-width":"120px","wrap-option":"warp","line-height":"0.9"}},ee={class:"pm-none"},oe=["onUpdate:modelValue","onInput"],te={class:"pm-none"},re=["onUpdate:modelValue","onInput"],se={class:"text-right pm-none"},le=["onUpdate:modelValue","onInput"],ae={class:"pm-none"},ne=["onUpdate:modelValue","onInput"],ie={class:"text-right pm-none text-bold"},de={class:"text-right pm-none"},pe={class:"pm-none"},ce=["onUpdate:modelValue"],me={class:"pm-none"},ue=["onUpdate:modelValue"],he={class:"pm-none"},ge=["onUpdate:modelValue"],ve={class:"pm-none text-right"},fe={class:"text-right"},be={class:"row"},xe={class:"col-12 col-md-6 q-pa-xs"},_e={class:"col-12 col-md-6 q-pa-xs"},ye={class:"col-12 col-md-6 q-pa-xs"},we={class:"col-12"},Ce={class:"pm-none",style:{display:"flex","align-items":"center"}},Ve={style:{"max-width":"120px","wrap-option":"warp","line-height":"0.9"}},Pe={class:"pm-none"},De={class:"pm-none text-red text-bold text-right"},Ue={class:"pm-none"},ke={class:"pm-none"},Fe={class:"row q-col-gutter-sm"},qe={class:"col-12"},Ne={class:"col-12 col-md-6"},Qe={class:"col-12 col-md-6"},Ie={class:"col-12"},Ee={class:"col-12"},Se={class:"row q-gutter-sm q-mt-md"};function Te(r,o,a,c,l,d){return u(),Q(M,{class:"q-pa-xs"},{default:n(()=>[s(w,{flat:"",bordered:""},{default:n(()=>[s(f,{class:"row items-center q-pb-none"},{default:n(()=>[o[16]||(o[16]=e("div",{class:"text-h6"},"Compras",-1)),s(m,{flat:"",round:"",dense:"",icon:"arrow_back",onClick:o[0]||(o[0]=t=>r.$router.back()),class:"q-mr-sm"})]),_:1}),s(f,{class:"q-pa-none"},{default:n(()=>[s(D,{onSubmit:d.clickDialogCompra},{default:n(()=>[e("div",z,[e("div",L,[s(h,{modelValue:l.productosSearch,"onUpdate:modelValue":[o[1]||(o[1]=t=>l.productosSearch=t),d.productosGet],outlined:"",clearable:"",label:"Buscar producto",dense:"",debounce:"300"},{append:n(()=>[s(m,{flat:"",round:"",dense:"",icon:"search"})]),_:1},8,["modelValue","onUpdate:modelValue"]),e("div",j,[s(G,{modelValue:l.pagination.page,"onUpdate:modelValue":[o[2]||(o[2]=t=>l.pagination.page=t),d.productosGet],max:Math.ceil(l.pagination.rowsNumber/l.pagination.rowsPerPage),"max-pages":"5",size:"xs","boundary-numbers":"",class:"q-mt-sm"},null,8,["modelValue","max","onUpdate:modelValue"])]),e("div",O,[(u(!0),b(V,null,C(l.productos,t=>(u(),b("div",H,[s(w,{flat:"",bordered:"",class:"cursor-pointer",onClick:x=>d.addProducto(t)},{default:n(()=>[s(P,{src:`${r.$url}../images/${t.imagen}`,class:"q-mb-xs",style:{height:"120px"}},{default:n(()=>[e("div",J,[e("div",X,p(r.$filters.textUpper(t.nombre)),1),e("div",Y,[e("span",null,p(t.cantidad),1),e("span",Z,p(t.precio)+" Bs",1)])])]),_:2},1032,["src"])]),_:2},1032,["onClick"])]))),256))])]),e("div",A,[e("div",K,[e("span",null,[s(m,{size:"xs",flat:"",round:"",dense:"",icon:"delete",color:"red",onClick:o[3]||(o[3]=t=>l.productosCompras=[]),class:"q-mb-sm"}),o[17]||(o[17]=e("span",{class:"text-subtitle2"},"Productos seleccionados",-1))]),e("span",null,[s(m,{size:"xs",dense:"",icon:"restore",color:"blue",class:"q-mb-sm",label:"Recuperar pedidos","no-caps":"",onClick:d.recuperarPedido},null,8,["onClick"])])]),s(F,{dense:"","wrap-cells":"",flat:"",bordered:""},{default:n(()=>[o[19]||(o[19]=e("thead",null,[e("tr",null,[e("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Producto"),e("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Cantidad"),e("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Precio unitario"),e("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Total"),e("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Factor"),e("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Precio unitario 1.25"),e("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Total"),e("th",{class:"pm-none",style:{"max-width":"60px","line-height":"0.9"}},"Precio venta"),e("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Lote"),e("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Fecha vencimiento"),e("th",{class:"pm-none",style:{"max-width":"70px","line-height":"0.9"}},"Dias vencimiento")])],-1)),e("tbody",null,[(u(!0),b(V,null,C(l.productosCompras,(t,x)=>{var _,y;return u(),b("tr",{key:x},[e("td",W,[s(P,{src:`${r.$url}../images/${(_=t.producto)==null?void 0:_.imagen}`,class:"q-mb-xs",style:{height:"35px",width:"35px"}},null,8,["src"]),e("div",$,[s(E,{name:"delete",color:"red",class:"cursor-pointer",onClick:i=>l.productosCompras.splice(x,1)},null,8,["onClick"]),S(" "+p(r.$filters.textUpper((y=t.producto)==null?void 0:y.nombre)),1)])]),e("td",ee,[g(e("input",{"onUpdate:modelValue":i=>t.cantidad=i,type:"number",min:"0",style:{width:"60px"},onInput:i=>d.onCantidadChange(t)},null,40,oe),[[v,t.cantidad,void 0,{number:!0}]])]),e("td",te,[g(e("input",{"onUpdate:modelValue":i=>t.precio=i,type:"number",min:"0",step:"0.001",style:{width:"70px"},onInput:i=>d.onPrecioChange(t)},null,40,re),[[v,t.precio,void 0,{number:!0}]])]),e("td",se,[g(e("input",{"onUpdate:modelValue":i=>t.total=i,type:"number",min:"0",step:"0.001",style:{width:"70px"},onInput:i=>d.onTotalChange(t)},null,40,le),[[v,t.total,void 0,{number:!0}]])]),e("td",ae,[g(e("input",{"onUpdate:modelValue":i=>t.factor=i,type:"number",min:"0",step:"0.001",style:{width:"60px"},onInput:i=>d.onFactorChange(t)},null,40,ne),[[v,t.factor,void 0,{number:!0}]])]),e("td",ie,p(parseFloat(t.precio*t.factor).toFixed(2)),1),e("td",de,p(parseFloat(t.cantidad*t.precio*t.factor).toFixed(2)),1),e("td",pe,[g(e("input",{"onUpdate:modelValue":i=>t.precio_venta=i,type:"number",style:{width:"55px",color:"red","font-weight":"bold"},step:"0.01"},null,8,ce),[[v,t.precio_venta]])]),e("td",me,[g(e("input",{"onUpdate:modelValue":i=>t.lote=i,type:"text",style:{width:"70px"}},null,8,ue),[[v,t.lote]])]),e("td",he,[g(e("input",{"onUpdate:modelValue":i=>t.fecha_vencimiento=i,type:"date",style:{width:"100px"}},null,8,ge),[[v,t.fecha_vencimiento]])]),e("td",ve,[e("span",{class:T(`text-bold ${new Date(t.fecha_vencimiento)-new Date<0||Math.ceil((new Date(t.fecha_vencimiento)-new Date)/(1e3*60*60*24))<30?"text-red":Math.ceil((new Date(t.fecha_vencimiento)-new Date)/(1e3*60*60*24))<60?"text-orange":"text-green"}`)},p(t.fecha_vencimiento?Math.ceil((new Date(t.fecha_vencimiento)-new Date)/(1e3*60*60*24)):""),3)])])}),128))]),e("tfoot",null,[e("tr",null,[o[18]||(o[18]=e("td",{colspan:"3",class:"text-right"},"Total",-1)),e("td",fe,p(d.totalCompra)+" Bs",1)])])]),_:1}),s(m,{label:"Registrar compra",color:"primary",class:"full-width","no-caps":"",loading:l.loading,type:"submit",icon:"add_circle_outline"},null,8,["loading"])])])]),_:1},8,["onSubmit"])]),_:1})]),_:1}),s(k,{modelValue:l.compraDialog,"onUpdate:modelValue":o[9]||(o[9]=t=>l.compraDialog=t)},{default:n(()=>[s(w,{style:{width:"600px"}},{default:n(()=>[s(f,{class:"row items-center q-pb-none"},{default:n(()=>[o[20]||(o[20]=e("div",{class:"text-h6"},"Confirmar compra",-1)),s(U),s(m,{flat:"",round:"",dense:"",icon:"close",onClick:o[4]||(o[4]=t=>l.compraDialog=!1)})]),_:1}),s(f,null,{default:n(()=>[s(D,{onSubmit:d.submitCompra},{default:n(()=>[e("div",be,[e("div",xe,[s(q,{modelValue:l.proveedor,"onUpdate:modelValue":[o[5]||(o[5]=t=>l.proveedor=t),o[6]||(o[6]=t=>{t?(this.compra.nombre=t.nombre||"",this.compra.ci=t.ci||""):(this.compra.nombre="",this.compra.ci="")})],options:l.proveedores,"option-label":"nombre","option-value":"id",label:"Proveedor",dense:"",outlined:"",rules:[t=>!!t||"Campo requerido"]},{append:n(()=>[s(m,{round:"",dense:"",flat:"",icon:"person_add",onClick:I(d.openProveedorDialog,["stop"]),title:"Nuevo proveedor"},null,8,["onClick"])]),_:1},8,["modelValue","options","rules"])]),e("div",_e,[s(q,{modelValue:l.compra.tipo_pago,"onUpdate:modelValue":o[7]||(o[7]=t=>l.compra.tipo_pago=t),options:["Efectivo","QR"],label:"Tipo de pago",dense:"",outlined:""},null,8,["modelValue"])]),e("div",ye,[s(h,{modelValue:l.compra.nro_factura,"onUpdate:modelValue":o[8]||(o[8]=t=>l.compra.nro_factura=t),outlined:"",dense:"",label:"Nro. factura"},null,8,["modelValue"])]),e("div",we,[s(F,{flat:"",dense:"","wrap-cells":"",bordered:""},{default:n(()=>[o[21]||(o[21]=e("thead",null,[e("tr",null,[e("th",{class:"pm-none",style:{"max-width":"60px","wrap-option":"wrap","line-height":"0.9"}},"Producto"),e("th",{class:"pm-none",style:{"max-width":"60px","wrap-option":"wrap","line-height":"0.9"}},"Cantidad"),e("th",{class:"pm-none",style:{"max-width":"60px","line-height":"0.9"}},"Precio venta"),e("th",{class:"pm-none",style:{"max-width":"60px","wrap-option":"wrap","line-height":"0.9"}},"Lote"),e("th",{class:"pm-none",style:{"max-width":"60px","wrap-option":"wrap","line-height":"0.9"}},"Fecha vencimiento")])],-1)),e("tbody",null,[(u(!0),b(V,null,C(l.productosCompras,(t,x)=>{var _,y;return u(),b("tr",{key:x},[e("td",Ce,[s(P,{src:`${r.$url}../images/${(_=t.producto)==null?void 0:_.imagen}`,class:"q-mb-xs",style:{height:"35px",width:"35px"}},null,8,["src"]),e("div",Ve,p(r.$filters.textUpper((y=t.producto)==null?void 0:y.nombre)),1)]),e("td",Pe,p(t.cantidad),1),e("td",De,p(t.precio_venta)+" Bs ",1),e("td",Ue,p(t.lote),1),e("td",ke,p(t.fecha_vencimiento),1)])}),128))])]),_:1})])]),s(m,{label:"Guardar compra",color:"primary",class:"full-width q-mt-md",type:"submit","no-caps":"",icon:"save",loading:l.loading},null,8,["loading"])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(k,{modelValue:l.proveedorDialog,"onUpdate:modelValue":o[15]||(o[15]=t=>l.proveedorDialog=t),persistent:""},{default:n(()=>[s(w,{style:{width:"520px","max-width":"90vw"}},{default:n(()=>[s(f,{class:"row items-center q-pb-none"},{default:n(()=>[o[22]||(o[22]=e("div",{class:"text-h6"},"Nuevo proveedor",-1)),s(U),s(m,{flat:"",round:"",dense:"",icon:"close",onClick:d.closeProveedorDialog},null,8,["onClick"])]),_:1}),s(f,null,{default:n(()=>[s(D,{ref:"formProveedorRef",onSubmit:d.saveProveedor},{default:n(()=>[e("div",Fe,[e("div",qe,[s(h,{modelValue:l.proveedorForm.nombre,"onUpdate:modelValue":o[10]||(o[10]=t=>l.proveedorForm.nombre=t),label:"Nombre *",dense:"",outlined:"",rules:[t=>!!t||"El nombre es obligatorio"]},null,8,["modelValue","rules"])]),e("div",Ne,[s(h,{modelValue:l.proveedorForm.ci,"onUpdate:modelValue":o[11]||(o[11]=t=>l.proveedorForm.ci=t),label:"CI",dense:"",outlined:""},null,8,["modelValue"])]),e("div",Qe,[s(h,{modelValue:l.proveedorForm.telefono,"onUpdate:modelValue":o[12]||(o[12]=t=>l.proveedorForm.telefono=t),label:"Tel\xE9fono",dense:"",outlined:""},null,8,["modelValue"])]),e("div",Ie,[s(h,{modelValue:l.proveedorForm.email,"onUpdate:modelValue":o[13]||(o[13]=t=>l.proveedorForm.email=t),label:"Email",type:"email",dense:"",outlined:""},null,8,["modelValue"])]),e("div",Ee,[s(h,{modelValue:l.proveedorForm.direccion,"onUpdate:modelValue":o[14]||(o[14]=t=>l.proveedorForm.direccion=t),label:"Direcci\xF3n",type:"textarea",autogrow:"",dense:"",outlined:""},null,8,["modelValue"])])]),e("div",Se,[s(U),s(m,{flat:"",label:"Cancelar",color:"grey-8",onClick:d.closeProveedorDialog},null,8,["onClick"]),s(m,{color:"primary",label:"Guardar",icon:"save",type:"submit",loading:l.loading},null,8,["loading"])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),o[23]||(o[23]=e("div",{id:"myElement",class:"hidden"},null,-1))]),_:1})}var Ae=N(R,[["render",Te]]);export{Ae as default};
